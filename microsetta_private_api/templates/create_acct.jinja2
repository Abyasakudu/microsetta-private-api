<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Account</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
    <script>
        function postAccount(theForm) {
            let url = window.location.href;
            let url_parts = url.split("/");
            // replace the name of this page with the
            // name of the page to go to after consent obtained
            url_parts[url_parts.length - 1]="main_survey.html";
            let url_wo_page = url_parts.join("/");

            let kit_name = $("#kit_name").val();
            let new_acct_data = {
                "address": {
                    "city": $("#city").val(),
                    "country_code": $("#country_code").val(),
                    "post_code": $("#post_code").val(),
                    "state": $("#state").val(),
                    "street": $("#street").val()
                },
                "email": $("#email").val(),
                "first_name": $("#first_name").val(),
                "last_name": $("#last_name").val(),
                "kit_name": kit_name
                };

            $.ajax({
                type: "GET",
                url: "http://localhost:8082/api/kits?kit_name=" + kit_name +"&language_tag=en-US",
                success: function(get_data, textStatus, request){
                    if (get_data.length > 0) {
                        //let sample_ids = get_data.map(x => x["sample_id"]);

                        $.ajax({
                            type: "POST",
                            url: "http://localhost:8082/api/accounts?language_tag=en-US",
                            data: JSON.stringify(new_acct_data),
                            success: function (post_data, textStatus, request) {
                                let loc_header = request.getResponseHeader('Location');
                                let queryParams = {
                                    "language_tag": "en-US",
                                    "kit_name": kit_name,
                                    "acct_api_url": encodeURIComponent(loc_header),
                                    "redirect_url": encodeURIComponent(url_wo_page)
                                };

                                let queryStr = $.param(queryParams);
                                let consent_url = "../static/consent.html?" + queryStr;
                                window.location.replace(consent_url);
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                alert(jqXHR.responseText);
                            },
                            dataType: "json",
                            contentType: "application/json"
                        });
                    } else {
                        alert("Unexpected number of available samples: " + get_data.length)
                    }
                },
                error: function(jqXHR, textStatus, errorThrown){
                    alert(jqXHR.responseText);
                },
                dataType: "json",
                contentType : "application/json"
            });

/*            $.ajax({
                type: "POST",
                url: "http://localhost:8082/api/accounts?language_tag=en-US",
                data: JSON.stringify(new_acct_data),
                success: function(data, textStatus, request){
                    let loc_header = request.getResponseHeader('Location');
                    let consent_api_url = loc_header + "/consent?language_tag=en-US";
                    consent_api_url = encodeURIComponent(consent_api_url);
                    let redirect_url = "../static/consent.html?target=" + consent_api_url;
                    window.location.replace(redirect_url);
                },
                error: function(jqXHR, textStatus, errorThrown){
                    alert(jqXHR.responseText);
                },
                dataType: "json",
                contentType : "application/json"
            });*/
        }
    </script>
</head>
<body>
    <form id="acct_form" name="acct_form" method="post">
        <div class="form-group">
            <p>
                NB: In future this will be disabled--value will be passed in from authentication
            </p>
            <label for="email" name="email_label">Email/Correo Electr√≥nico</label>
            <!-- in future, this will be disabled and value will be filled in from login -->
            <input id="email" name="email" class="form-control" type="text" value="ab@example.com"/>
        </div>
        <div class="form-group">
            <label for="first_name" name="first_name_label">First Name/Nombre</label>
            <input id="first_name" name="first_name" class="form-control" type="text" value="Tester" />
        </div>
        <div class="form-group">
            <label for="last_name" name="last_name_label">Last Name/Nombre de Familia</label>
            <input id="last_name" name="last_name" class="form-control" type="text" value="McTestFace" />
        </div>
        <div class="form-group">
            <label for="street" name="street_label" >Street Address/Direccion</label>
            <input id="street" name="street" class="form-control" type="text" value="145 Gine St" />
        </div>
        <div class="form-group">
            <label for="city" name="city_label">City/Ciudad</label>
            <input id="city" name="city" class="form-control" type="text" value="San Diego" />
        </div>
        <div class="form-group">
            <label for="state" name="state_label">State/Estado</label>
            <select id="state" name="state" class="form-control" >
                <option value="CA">California</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="DC">District Of Columbia</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
            </select>
        </div>
        <div class="form-group">
            <label for="post_code" name="post_code_label">Zip Code/Codigo Postal</label>
            <input id="post_code" name="post_code" class="form-control" type="text" value="99226"/>
        </div>
        <div class="form-group">
            <label for="kit_name" name="kit_name_label">Kit Name/Nombre de Kit</label>
            <input id="kit_name" name="kit_name" class="form-control" type="text" value="fa_lrfiq"/>
        </div>
        <input id="country_code" name="country_code" type="hidden" value="US"/>
        <input type="submit" class="btn btn-primary"/>
    </form>
</body>
</html>